// Movie Data with download functionality
window.moviesData = [
    {
        id: 1,
        title: "Плохие парни 2",
        year: 2025,
        rating: 7.6,
        duration: "1h 44m",
        genre: ["Мультфильм", "Боевик", "Комедия, Криминал, Детектив, Семейный"],
        description: "Плохие парни пытаются адаптироваться к новой жизни, когда их просят вернуться к криминальной жизни и выполнить последнее задание.",
        poster: "https://images-ext-1.discordapp.net/external/AOwPqLXbOrJNGgB-SAvGhYgrhvzvxvRZwNfFhhewLRo/https/go.filmitorrent3.site/uploads/posts/2025-08/thumbs/1756046182_6ee2496ff9.jpg?format=webp",
        featured: true,
        downloadFile: "movies/bad2.torrent",
        fileSize: "1.46 GB",
        quality: "1080p",
        format: "mp4",
        downloadCount: 10395,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/d848a66e4b166cec1bdcdd2135f51445/"
    },
    {
        id: 2,
        title: "Уэнсдей (сериал, +2 сезон)",
        year: 2025,
        rating: 7.9,
        duration: "2 сезона",
        genre: ["Фэнтези", "Комедия", "Криминал","Детектив", "Семейный"],
        description: "Уэнсдэй, дочь Гомеса и Мортиши Аддамс, учится в академии Nevermore. Ей предстоит освоить экстрасенсорные способности, чтобы остановить местного серийного убийцу и раскрыть тайну родителей.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414037798771626054/1707878801_cb1f2be290.jpg?ex=68be1cd2&is=68bccb52&hm=80117659742b6ad815de0700346a55602688c6279c03170dce0dcc216744fdf6&=&format=webp",
        featured: true,
        downloadFile: "movies/Wednesday.torrent",
        fileSize: "4.9 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 108700,
        isAvailable: true,
        isSeries: true,
        trailerUrl: "https://yandex.ru/video/preview/4424977275573606300"
    },
    {
        id: 3,
        title: "Одно целое",
        year: 2025,
        rating: 6.6,
        duration: "1h 42m",
        genre: ["Ужасы"],
        description: "После переезда в уединённый загородный дом пара, переживающая кризис в отношениях, сталкивается с необъяснимым явлением: их тела начинают тянуться друг к другу с пугающей силой. Чтобы спастись, им предстоит раскрыть тайну этого места, прежде чем они сольются в одно целое.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414162791274643507/1756209934_4cc1af43a1.jpg?ex=68be913b&is=68bd3fbb&hm=e2bac2eb2e04e21c95c099943f4f85d28c8ff692123f1a3b9a4990360e4d274c&=&format=webp",
        featured: false,
        downloadFile: "movies/Together.torrent",
        fileSize: "1.47 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 11348,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
    },
    {
        id: 4,
        title: "Свободные люди",
        year: 2025,
        rating: 6.4,
        duration: "1h 42m",
        genre: ["Триллер", "Криминал", "Драма"],
        description: "Отец и сын, называющие себя «свободные люди», оказываются в противостоянии с начальником полиции, что приводит к охоте на них.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414164334636040192/1756403780_2beebfff85.jpg?ex=68be92ab&is=68bd412b&hm=2c4b770049b45a636bc833a90d6853abb2336d788cb22917711bbe7bd742a209&=&format=webp",
        featured: false,
        downloadFile: "movies/Svobodnye_lyudi.torrent",
        fileSize: "1.46 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 9255,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
    },
    {
        id: 5,
        title: "Я знаю, что вы сделали прошлым летом",
        year: 2025,
        rating: 5.5,
        duration: "1h 51m",
        genre: ["Ужасы","Триллер","Детектив"],
        description: "4 июля, отправившись смотреть салют после помолвки Дэники и Тедди, пятеро друзей становятся невольными виновниками автокатастрофы, в результате которой гибнет человек. Они решают никому не говорить об этом, а богатый отец Тедди делает всё, чтобы замять произошедшее. Год спустя Дэника собирается замуж за другого и, открывая подарки на девичнике, обнаруживает записку — «Я знаю, что вы сделали прошлым летом». Этим же вечером её жениха жестоко убивает неизвестный с огромным крюком.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414165614754533446/1756471390_9bf5b60db4.jpg?ex=68be93dc&is=68bd425c&hm=9732a9b6493252441e0f644523e19e1156a891e9cc5d994e116d4f0de51f6646&=&format=webp",
        featured: false,
        downloadFile: "movies/I.Know.What.You.Did.Last.Summer.torrent",
        fileSize: "1.46 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 13529,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
        
    },
    {
        id: 6,
        title: "На деревню к дедушке",
        year: 2025,
        rating: 7.0,
        duration: "1h 30m",
        genre: ["Комедия"],
        description: "10-летний Владик — гений нейросетей и мастер по избавлению от нянь. Когда маме срочно нужно уехать в командировку, ему приходится отправиться в деревню к дедушке, которого он ни разу в жизни не видел. Владик мечтает вернуться в город и попасть на важный IT-конкурс, а дед вовсе не намерен идти у него на поводу. Каждый из них уверен, что легко перехитрит другого, но эта встреча изменит их обоих.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414167135072030771/1756485539_0eaf502dbf.jpg?ex=68be9546&is=68bd43c6&hm=e07191066d37cfdf633afd265d45b57dcfe7731efb3df5fbd098572ece80fc93&=&format=webp",
        featured: false,
        downloadFile: "movies/Na.derevnyu.dedushke.torrent",
        fileSize: "1.46 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 6054,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
        
    },
    {
        id: 7,
        title: "Клуб убийств по четвергам",
        year: 2025,
        rating: 7.0,
        duration: "1h 58m",
        genre: ["Детектив","Комедия","Криминал"],
        description: "Великобритания. Элизабет, Рон и Ибрахим — постояльцы элитного дома престарелых, которые в качестве хобби по четвергам проводят время за расследованием старых убийств. Взяв в свой «Клуб убийств по четвергам» новенькую Джойс, в прошлом медсестру, команда решает заняться расследованием убийства их знакомого, которое на днях произошло неподалёку.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414168257514049607/1756525051_e04145b02b.jpg?ex=68be9652&is=68bd44d2&hm=e26e84e8f897f90cf860032777c51ff654b3c6abb98bfaaf50f897cf994ad090&=&format=webp",
        featured: false,
        downloadFile: "movies/The_Thursday_Murder_Club.torrent",
        fileSize: "1.46 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 16392,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
        
    },
    {
        id: 8,
        title: "Скрежет металла (сериал, +2 сезон)",
        year: 2025,
        rating: 7.3,
        duration: "2 сезона",
        genre: ["Фантастика","Боевик","Комедия"],
        description: "Джон Доу бороздит просторы постапокалиптической Америки на оснащённом оружием автомобиле. Он должен выполнить опасную миссию, но ему мешает безумный клоун-убийца Сладкоежка.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414169064670232626/1696270716_ecddedfafb.jpg?ex=68be9713&is=68bd4593&hm=2142a6b2bc99f9867d12d2672046f23b967ed30f428961be66e8d7db611fcf8c&=&format=webp",
        featured: false,
        downloadFile: "movies/Skrezhet_metalla_Sezon_1.torrent",
        fileSize: "5.06 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 56719,
        isAvailable: true,
        isSeries: true,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
        
    },
    {
        id: 8,
        title: "Голый пистолет",
        year: 2025,
        rating: 6.6,
        duration: "1h 25m",
        genre: ["Боевик","Комедия","Криминал"],
        description: "Лос-Анджелес. Во время ограбления банка в бой с бандитами вступает Фрэнк Дребин — младший из полицейского отряда, сын легендарного копа Фрэнка Дребина. Однако злоумышленникам все-таки удаётся вынести некий секретный агрегат из банковской ячейки и передать его главе IT-корпорации Ричарду Кейну. Дребину, который разнёс половину банка, в наказание дают другое дело — об автомобильной аварии, в которой по странному стечению обстоятельств погибает один из подчиненных Кейна. Пока Фрэнк пытается связать одно происшествие с другим, он встречается с Бэт, которая оказывается сестрой погибшего, а также сочинительницей тру-крайма, «основанного на придуманных ею же убийствах».",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414170066479484938/1756833332_296d7a02bb.jpg?ex=68be9801&is=68bd4681&hm=51d2c98645a73f23d0aa657521d348429519bf3b98f13891c43a1166a6e8bb0e&=&format=webp",
        featured: false,
        downloadFile: "movies/The.Naked.Gun.torrent",
        fileSize: "1.64 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 8874,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
        
    },
    {
        id: 9,
        title: "Никто 2",
        year: 2025,
        rating: 6.5,
        duration: "1h 29m",
        genre: ["Боевик","Комедия","Криминал"],
        description: "Разобравшись с русской мафией и уничтожив денежный склад, Хатч расстроил влиятельных людей, деньги которых сгорели в огне. Теперь, чтобы компенсировать потери, он снова работает киллером. После очередного сложного заказа Хатч просит босса о передышке. Он хочет взять отпуск и побыть с семьёй, от которой снова отдалился. Приехав с роднёй в небольшой курортный городок, где он однажды побывал в детстве, мужчина наслаждается безмятежным отдыхом, не подозревая, что скоро неприятности найдут его и здесь.",
        poster: "https://media.discordapp.net/attachments/1352590728630505592/1414170756572643380/1756893102_73d8189541.jpg?ex=68be98a6&is=68bd4726&hm=3d17a0f4c9b53cc5625e8f2ab08447f94b60e2fa2d2f0b297fe5e18d831919df&=&format=webp",
        featured: false,
        downloadFile: "movies/The_Thursday_Murder_Club.torrent",
        fileSize: "1.46 GB",
        quality: "1080p",
        format: "MP4",
        downloadCount: 10128,
        isAvailable: true,
        isSeries: false,
        trailerUrl: "https://rutube.ru/video/e8ffaa2fd33ace01c25d4b8e981234b0/?r=plemwd"
        
    },
    
];

// Global Variables
let currentMovies = [...moviesData];
let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
let currentFilter = 'all';
let currentSort = 'rating';
let currentView = 'grid';
let currentPage = 1;
let moviesPerPage = 24;
let totalPages = 1;

// Statistics tracking
let siteStats = JSON.parse(localStorage.getItem('siteStats')) || {
    totalUsers: 0,
    uniqueVisitors: [],
    lastVisit: null
};

// Convert array back to Set for easier manipulation
if (siteStats.uniqueVisitors && Array.isArray(siteStats.uniqueVisitors)) {
    siteStats.uniqueVisitors = new Set(siteStats.uniqueVisitors);
} else {
    siteStats.uniqueVisitors = new Set();
}

// DOM Elements
const searchInput = document.getElementById('searchInput');
const heroSearch = document.getElementById('heroSearch');
const moviesGrid = document.getElementById('moviesGrid');
const filterTabs = document.querySelectorAll('.filter-tab');
const yearFilter = document.getElementById('yearFilter');
const ratingFilter = document.getElementById('ratingFilter');
const sortBtn = document.getElementById('sortBtn');
const viewBtns = document.querySelectorAll('.view-btn');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const favoritesBtn = document.getElementById('favoritesBtn');
const favoritesCount = document.querySelector('.favorites-count');
const themeToggle = document.getElementById('themeToggle');
const movieModal = document.getElementById('movieModal');
const modalClose = document.querySelector('.close');

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Show loading screen first
    showLoadingScreen();
    
    // Simulate loading process
    simulateLoading(() => {
        // Hide loading screen and initialize app
        hideLoadingScreen();
        
        updateSiteStats(); // Track visitor
        updateStatistics(); // Update stats display
        renderMovies();
        renderFeaturedMovies(); // Render featured section
        updateFavoritesCount();
        setupEventListeners();
        loadTheme();
        setupHeaderFunctionality();
    });
}

// Header Functionality
function setupHeaderFunctionality() {
    // Header scroll effect
    window.addEventListener('scroll', handleHeaderScroll);
    
    // Search suggestions
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('focus', showSearchSuggestions);
        searchInput.addEventListener('blur', hideSearchSuggestions);
    }
    
    // User dropdown
    const userBtn = document.getElementById('userBtn');
    const userMenu = document.getElementById('userMenu');
    if (userBtn && userMenu) {
        userBtn.addEventListener('click', toggleUserMenu);
        document.addEventListener('click', (e) => {
            if (!userBtn.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        });
        
        // Add click handlers for menu items
        const menuItems = userMenu.querySelectorAll('.user-menu-item');
        menuItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const text = item.textContent.trim();
                
                switch(text) {
                    case 'Профиль':
                        openProfileModal();
                        break;
                    case 'Мои скачивания':
                        openDownloadsModal();
                        break;
                    case 'Настройки':
                        openSettingsModal();
                        break;
                    case 'Выйти':
                        logout();
                        break;
                }
                
                userMenu.classList.remove('show');
            });
        });
    }
    
    // Newsletter form
    const newsletterForm = document.getElementById('newsletterForm');
    if (newsletterForm) {
        newsletterForm.addEventListener('submit', handleNewsletterSubmit);
    }

    // Header nav links: Фильмы, Сериалы, Жанры, Топ
    const navLinks = document.querySelectorAll('.nav-menu .nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const text = link.textContent.trim();
            // Smooth scroll to movies block by default for these sections
            const moviesSection = document.querySelector('#movies');
            if (moviesSection) {
                moviesSection.scrollIntoView({ behavior: 'smooth' });
            }

            // Apply contextual filters
            switch (text) {
                case 'Фильмы':
                    currentFilter = 'all';
                    currentMovies = moviesData.filter(m => !m.isSeries);
                    break;
                case 'Сериалы':
                    currentFilter = 'series_only';
                    currentMovies = moviesData.filter(m => !!m.isSeries);
                    break;
                case 'Жанры':
                    // Open genre filter panel by focusing tabs
                    currentFilter = 'all';
                    currentMovies = [...moviesData];
                    break;
                case 'Топ':
                    currentFilter = 'top';
                    currentMovies = [...moviesData].sort((a,b) => b.rating - a.rating).slice(0, 24);
                    break;
                default:
                    return; // allow default anchor behavior if any
            }

            e.preventDefault();
            currentPage = 1;
            renderMovies();
            updatePaginationInfo();
            renderPagination();

            // Update active state on nav
            document.querySelectorAll('.nav-menu .nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
        });
    });
}

function handleHeaderScroll() {
    const header = document.querySelector('.header');
    if (window.scrollY > 100) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }
}

function handleSearchInput(e) {
    const query = e.target.value.trim();
    if (query.length < 2) {
        hideSearchSuggestions();
        return;
    }
    
    showSearchSuggestions(query);
}

function showSearchSuggestions(query) {
    const suggestions = moviesData
        .filter(movie => 
            movie.title.toLowerCase().includes(query.toLowerCase()) ||
            movie.genre.some(g => g.toLowerCase().includes(query.toLowerCase()))
        )
        .slice(0, 5);
    
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (!suggestionsContainer) return;
    
    if (suggestions.length === 0) {
        suggestionsContainer.innerHTML = `
            <div class="search-suggestion">
                <div class="search-suggestion-info">
                    <h4>Ничего не найдено</h4>
                    <p>Попробуйте другой запрос</p>
                </div>
            </div>
        `;
    } else {
        suggestionsContainer.innerHTML = suggestions.map(movie => `
            <div class="search-suggestion" onclick="selectSuggestion('${movie.title}')">
                <img src="${movie.poster}" alt="${movie.title}">
                <div class="search-suggestion-info">
                    <h4>${movie.title}</h4>
                    <p>${movie.year} • ${movie.genre.join(', ')}</p>
                </div>
            </div>
        `).join('');
    }
    
    suggestionsContainer.style.display = 'block';
}

function hideSearchSuggestions() {
    setTimeout(() => {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        if (suggestionsContainer) {
            suggestionsContainer.style.display = 'none';
        }
    }, 200);
}

function selectSuggestion(title) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = title;
        searchInput.focus();
        hideSearchSuggestions();
        handleSearch({ target: { value: title } });
    }
}

function toggleUserMenu() {
    const userMenu = document.getElementById('userMenu');
    if (userMenu) {
        userMenu.classList.toggle('show');
    }
}

function handleNewsletterSubmit(e) {
    e.preventDefault();
    const email = e.target.querySelector('input[type="email"]').value;
    
    // Simulate newsletter subscription
    showNotification('Спасибо за подписку! Вы будете получать уведомления о новых фильмах.', 'success');
    e.target.reset();
}

// User Profile Functions
function openProfileModal() {
    const modal = document.getElementById('profileModal');
    if (!modal) return;
    
    // Load user data
    loadUserProfile();
    
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('show'), 10);
    document.body.style.overflow = 'hidden';
}

function closeProfileModal() {
    const modal = document.getElementById('profileModal');
    if (!modal) return;
    
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.animation = 'modalContentSlideOut 0.3s ease forwards';
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        modalContent.style.animation = '';
    }, 300);
}

function loadUserProfile() {
    const userData = JSON.parse(localStorage.getItem('userProfile')) || {
        firstName: 'Иван',
        lastName: 'Иванов',
        email: 'user@example.com',
        downloads: 0,
        favorites: 0
    };
    
    document.getElementById('profileName').textContent = `${userData.firstName} ${userData.lastName}`;
    document.getElementById('profileEmail').textContent = userData.email;
    document.getElementById('profileFirstName').value = userData.firstName;
    document.getElementById('profileLastName').value = userData.lastName;
    document.getElementById('profileEmailInput').value = userData.email;
    document.getElementById('profileDownloads').textContent = userData.downloads;
    document.getElementById('profileFavorites').textContent = userData.favorites;
}

function saveProfile() {
    const userData = {
        firstName: document.getElementById('profileFirstName').value,
        lastName: document.getElementById('profileLastName').value,
        email: document.getElementById('profileEmailInput').value,
        downloads: parseInt(document.getElementById('profileDownloads').textContent),
        favorites: parseInt(document.getElementById('profileFavorites').textContent)
    };
    
    localStorage.setItem('userProfile', JSON.stringify(userData));
    showNotification('Профиль сохранен!', 'success');
    closeProfileModal();
}

// Downloads Functions
function openDownloadsModal() {
    const modal = document.getElementById('downloadsModal');
    if (!modal) return;
    
    loadDownloads();
    
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('show'), 10);
    document.body.style.overflow = 'hidden';
}

function closeDownloadsModal() {
    const modal = document.getElementById('downloadsModal');
    if (!modal) return;
    
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.animation = 'modalContentSlideOut 0.3s ease forwards';
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        modalContent.style.animation = '';
    }, 300);
}

function loadDownloads() {
    const downloads = JSON.parse(localStorage.getItem('userDownloads')) || [];
    const downloadsList = document.getElementById('downloadsList');
    
    if (downloads.length === 0) {
        downloadsList.innerHTML = `
            <div class="no-results">
                <i class="fas fa-download"></i>
                <h3>Нет скачиваний</h3>
                <p>Начните скачивать фильмы, чтобы они появились здесь</p>
            </div>
        `;
        return;
    }
    
    downloadsList.innerHTML = downloads.map(download => `
        <div class="download-item">
            <img src="${download.poster}" alt="${download.title}">
            <div class="download-item-info">
                <h4>${download.title}</h4>
                <p>${download.year} • ${download.quality} • ${download.fileSize}</p>
                <p>Ваши скачивания этого фильма: <strong>${(JSON.parse(localStorage.getItem('perUserDownloadCounts')||'{}'))[download.id]||0}</strong></p>
                <p>Скачано: ${new Date(download.downloadDate).toLocaleDateString()}</p>
            </div>
            <div class="download-item-actions">
                <button class="btn btn-sm btn-primary" onclick="redownloadMovie(${download.id})">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="removeDownload(${download.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    // Update stats
    document.getElementById('totalDownloads').textContent = downloads.length;
    const monthlyDownloads = downloads.filter(d => {
        const downloadDate = new Date(d.downloadDate);
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        return downloadDate > monthAgo;
    }).length;
    document.getElementById('monthlyDownloads').textContent = monthlyDownloads;
}

function addToDownloads(movie) {
    const downloads = JSON.parse(localStorage.getItem('userDownloads')) || [];
    const download = {
        id: movie.id,
        title: movie.title,
        year: movie.year,
        poster: movie.poster,
        quality: movie.quality,
        fileSize: movie.fileSize,
        downloadDate: new Date().toISOString()
    };
    
    // Check if already exists
    const existingIndex = downloads.findIndex(d => d.id === movie.id);
    if (existingIndex > -1) {
        downloads[existingIndex] = download;
    } else {
        downloads.unshift(download);
    }
    
    localStorage.setItem('userDownloads', JSON.stringify(downloads));
}

function redownloadMovie(movieId) {
    const movie = moviesData.find(m => m.id === movieId);
    if (movie) {
        downloadMovie(movieId);
        showNotification(`Повторное скачивание ${movie.title}`, 'info');
    }
}

function removeDownload(movieId) {
    const downloads = JSON.parse(localStorage.getItem('userDownloads')) || [];
    const filteredDownloads = downloads.filter(d => d.id !== movieId);
    localStorage.setItem('userDownloads', JSON.stringify(filteredDownloads));
    loadDownloads();
    showNotification('Скачивание удалено', 'info');
}

// Settings Functions
function openSettingsModal() {
    const modal = document.getElementById('settingsModal');
    if (!modal) return;
    
    loadSettings();
    
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('show'), 10);
    document.body.style.overflow = 'hidden';
}

function closeSettingsModal() {
    const modal = document.getElementById('settingsModal');
    if (!modal) return;
    
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.animation = 'modalContentSlideOut 0.3s ease forwards';
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        modalContent.style.animation = '';
    }, 300);
}

function loadSettings() {
    const settings = JSON.parse(localStorage.getItem('userSettings')) || {
        theme: 'dark',
        language: 'ru',
        emailNotifications: true,
        pushNotifications: true,
        downloadPath: 'C:\\Downloads\\Movies',
        defaultQuality: '1080p'
    };
    
    document.getElementById('themeSelect').value = settings.theme;
    document.getElementById('languageSelect').value = settings.language;
    document.getElementById('emailNotifications').checked = settings.emailNotifications;
    document.getElementById('pushNotifications').checked = settings.pushNotifications;
    document.getElementById('downloadPath').value = settings.downloadPath;
    document.getElementById('defaultQuality').value = settings.defaultQuality;
}

function saveSettings() {
    const settings = {
        theme: document.getElementById('themeSelect').value,
        language: document.getElementById('languageSelect').value,
        emailNotifications: document.getElementById('emailNotifications').checked,
        pushNotifications: document.getElementById('pushNotifications').checked,
        downloadPath: document.getElementById('downloadPath').value,
        defaultQuality: document.getElementById('defaultQuality').value
    };
    
    localStorage.setItem('userSettings', JSON.stringify(settings));
    
    // Apply theme
    if (settings.theme === 'light') {
        document.body.classList.add('light-theme');
    } else if (settings.theme === 'dark') {
        document.body.classList.remove('light-theme');
    }
    
    showNotification('Настройки сохранены!', 'success');
    closeSettingsModal();
}

function resetSettings() {
    if (confirm('Вы уверены, что хотите сбросить все настройки?')) {
        localStorage.removeItem('userSettings');
        loadSettings();
        showNotification('Настройки сброшены', 'info');
    }
}

function selectDownloadPath() {
    // In a real app, this would open a folder picker
    const path = prompt('Введите путь к папке для скачиваний:');
    if (path) {
        document.getElementById('downloadPath').value = path;
    }
}

// Logout function
function logout() {
    if (confirm('Вы уверены, что хотите выйти?')) {
        localStorage.removeItem('userProfile');
        localStorage.removeItem('userDownloads');
        localStorage.removeItem('userSettings');
        showNotification('Вы вышли из системы', 'info');
        
        // Reset UI
        document.getElementById('profileName').textContent = 'Пользователь';
        document.getElementById('profileEmail').textContent = 'user@example.com';
    }
}

// Event Listeners
function setupEventListeners() {
    // Search functionality
    searchInput.addEventListener('input', debounce(handleSearch, 300));
    heroSearch.addEventListener('input', debounce(handleSearch, 300));
    
    // Filter functionality
    filterTabs.forEach(tab => {
        tab.addEventListener('click', () => handleFilter(tab.dataset.filter));
    });
    
    yearFilter.addEventListener('change', handleFilterChange);
    ratingFilter.addEventListener('change', handleFilterChange);
    sortBtn.addEventListener('click', handleSort);
    
    // View toggle
    viewBtns.forEach(btn => {
        btn.addEventListener('click', () => handleViewChange(btn.dataset.view));
    });
    
    // Movies per page selector
    const moviesPerPageSelect = document.getElementById('moviesPerPage');
    if (moviesPerPageSelect) {
        moviesPerPageSelect.addEventListener('change', (e) => {
            changeMoviesPerPage(e.target.value);
        });
    }
    
    // Favorites
    favoritesBtn.addEventListener('click', toggleFavoritesView);
    
    // Theme toggle
    themeToggle.addEventListener('click', toggleTheme);
    
    // Modal
    modalClose.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => {
        if (e.target === movieModal) {
            closeModal();
        }
    });
    
    // Mobile menu
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const navMenu = document.querySelector('.nav-menu');
    
    mobileMenuToggle.addEventListener('click', () => {
        const isOpen = navMenu.style.display === 'block';
        navMenu.style.display = isOpen ? 'none' : 'block';
    });

    // Close menu on link click (mobile)
    document.querySelectorAll('.nav-menu .nav-link').forEach(a => {
        a.addEventListener('click', () => {
            if (window.innerWidth <= 768) navMenu.style.display = 'none';
        });
    });
}

// Search Functionality
function handleSearch(e) {
    const query = e.target.value.toLowerCase().trim();
    
    if (query === '') {
        currentMovies = [...moviesData];
    } else {
        currentMovies = moviesData.filter(movie => 
            movie.title.toLowerCase().includes(query) ||
            movie.genre.some(g => g.toLowerCase().includes(query)) ||
            movie.description.toLowerCase().includes(query)
        );
    }
    
    currentPage = 1;
    renderMovies();
}

// Filter Functionality
function handleFilter(filter) {
    currentFilter = filter;
    
    // Update active tab
    filterTabs.forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
            tab.classList.add('active');
        }
    });
    
    applyFilters();
}

function handleFilterChange() {
    applyFilters();
}

function applyFilters() {
    let filtered = [...moviesData];
    
    // Genre filter
    if (currentFilter !== 'all') {
        filtered = filtered.filter(movie => 
            movie.genre.some(g => g.toLowerCase().includes(currentFilter))
        );
    }
    
    // Year filter
    const selectedYear = yearFilter.value;
    if (selectedYear) {
        filtered = filtered.filter(movie => movie.year.toString() === selectedYear);
    }
    
    // Rating filter
    const selectedRating = ratingFilter.value;
    if (selectedRating) {
        filtered = filtered.filter(movie => movie.rating >= parseFloat(selectedRating));
    }
    
    currentMovies = filtered;
    currentPage = 1;
    renderMovies();
}

// Sort Functionality
function handleSort() {
    const sortOptions = ['rating', 'year', 'title'];
    const currentIndex = sortOptions.indexOf(currentSort);
    const nextIndex = (currentIndex + 1) % sortOptions.length;
    currentSort = sortOptions[nextIndex];
    
    sortBtn.innerHTML = `<i class="fas fa-sort"></i> ${getSortLabel(currentSort)}`;
    sortMovies();
}

function getSortLabel(sort) {
    const labels = {
        'rating': 'По рейтингу',
        'year': 'По году',
        'title': 'По названию'
    };
    return labels[sort];
}

function sortMovies() {
    currentMovies.sort((a, b) => {
        switch (currentSort) {
            case 'rating':
                return b.rating - a.rating;
            case 'year':
                return b.year - a.year;
            case 'title':
                return a.title.localeCompare(b.title);
            default:
                return 0;
        }
    });
    
    renderMovies();
}

// View Toggle
function handleViewChange(view) {
    currentView = view;
    
    viewBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        }
    });
    
    renderMovies();
}

// Render Movies
function renderMovies() {
    const moviesToShow = getCurrentPageMovies();
    
    if (moviesToShow.length === 0) {
        moviesGrid.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>Фильмы не найдены</h3>
                <p>Попробуйте изменить параметры поиска</p>
            </div>
        `;
        return;
    }
    
    moviesGrid.innerHTML = moviesToShow.map(movie => createMovieCard(movie)).join('');
    
    // Update pagination
    updatePaginationInfo();
    renderPagination();
    
    // Add click listeners to movie cards
    document.querySelectorAll('.movie-card').forEach(card => {
        card.addEventListener('click', () => {
            const movieId = parseInt(card.dataset.movieId);
            const movie = moviesData.find(m => m.id === movieId);
            openModal(movie);
        });
    });
}

function createMovieCard(movie) {
    const isFavorite = favorites.includes(movie.id);
    const downloadStatus = movie.isAvailable ? 'available' : 'unavailable';
    
    return `
        <div class="movie-card ${currentView === 'list' ? 'list-view' : ''}" data-movie-id="${movie.id}">
            <div class="movie-poster">
                <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
                <div class="movie-overlay">
                    <button class="play-btn" onclick="openModal(${movie.id})">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="movie-quality-badge">
                        <span class="quality-tag">${movie.quality}</span>
                    </div>
                </div>
                <div class="download-stats">
                    <span class="download-count">
                        <i class="fas fa-download"></i>
                        ${formatNumber(movie.downloadCount)}
                    </span>
                </div>
            </div>
            <div class="movie-info">
                <h3 class="movie-title">${movie.title}</h3>
                <div class="movie-meta">
                    <span class="movie-year">${movie.year}</span>
                    <div class="movie-rating">
                        <i class="fas fa-star"></i>
                        <span>${movie.rating}</span>
                    </div>
                </div>
                <div class="movie-file-info">
                    <span class="file-size">${movie.fileSize}</span>
                    <span class="file-format">${movie.format}</span>
                </div>
                <div class="movie-genres">
                    ${movie.genre.map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                </div>
                <div class="movie-actions">
                    <button class="btn btn-download ${downloadStatus}" onclick="downloadMovie(${movie.id}, event)" ${!movie.isAvailable ? 'disabled' : ''}>
                        ${movie.isAvailable ? 
                            (movie.downloadFile.toLowerCase().endsWith('.torrent') ? 
                                '<i class="fas fa-magnet"></i> Торрент' : 
                                '<i class="fas fa-download"></i> Скачать') : 
                            '<i class="fas fa-times"></i> Недоступно'}
                    </button>
                    <button class="btn btn-secondary ${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite(${movie.id}, event)">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button class="btn btn-info" onclick="openModal(${movie.id})">
                        <i class="fas fa-info"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Load More
function handleLoadMore() {
    currentPage++;
    renderMovies();
}

// Favorites Functionality
function toggleFavorite(movieId, event) {
    event.stopPropagation();
    
    const index = favorites.indexOf(movieId);
    if (index > -1) {
        favorites.splice(index, 1);
    } else {
        favorites.push(movieId);
    }
    
    localStorage.setItem('favorites', JSON.stringify(favorites));
    updateFavoritesCount();
    
    // Update button state
    const button = event.target.closest('.btn-secondary');
    if (favorites.includes(movieId)) {
        button.classList.add('favorited');
    } else {
        button.classList.remove('favorited');
    }
}

function updateFavoritesCount() {
    favoritesCount.textContent = favorites.length;
}

function toggleFavoritesView() {
    if (currentFilter === 'favorites') {
        handleFilter('all');
    } else {
        currentMovies = moviesData.filter(movie => favorites.includes(movie.id));
        currentFilter = 'favorites';
        renderMovies();
    }
}

// Download Functionality
function downloadMovie(movieId, event) {
    if (event) event.stopPropagation();
    
    const movie = moviesData.find(m => m.id === movieId);
    if (!movie || !movie.isAvailable) {
        showNotification('Фильм недоступен для скачивания', 'error');
        return;
    }
    
    // Check if it's a torrent file
    const isTorrentFile = movie.downloadFile.toLowerCase().endsWith('.torrent');
    
    if (isTorrentFile) {
        // Handle torrent download
        downloadTorrentFile(movie);
    } else {
        // Handle regular file download
        downloadRegularFile(movie);
    }
}

function downloadTorrentFile(movie) {
    // Show download progress for torrent
    showDownloadProgress(movie, 'torrent');
    
    setTimeout(() => {
        try {
            // Try to download the file
            const link = document.createElement('a');
            link.href = movie.downloadFile;
            link.download = `${movie.title} (${movie.year}).torrent`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Update download count
            movie.downloadCount++;

            // Per-user counter
            const perUser = JSON.parse(localStorage.getItem('perUserDownloadCounts') || '{}');
            perUser[movie.id] = (perUser[movie.id] || 0) + 1;
            localStorage.setItem('perUserDownloadCounts', JSON.stringify(perUser));
            
            // Add to user downloads
            addToDownloads(movie);
            
            // Update user profile stats
            updateUserStats();
            
            // Show success message with instructions
            showTorrentDownloadInstructions(movie);
            
        } catch (error) {
            console.error('Error downloading torrent:', error);
            // If direct download fails, show instructions
            showTorrentDownloadInstructions(movie);
        }
    }, 1500);
}

function showTorrentDownloadInstructions(movie) {
    // Create a modal with download instructions
    const modal = document.createElement('div');
    modal.className = 'torrent-instructions-modal';
    modal.innerHTML = `
        <div class="torrent-instructions-content">
            <div class="torrent-instructions-header">
                <div class="torrent-icon">
                    <i class="fas fa-magnet"></i>
                </div>
                <h3>Скачивание торрент файла</h3>
                <button class="close-btn" onclick="this.closest('.torrent-instructions-modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="torrent-instructions-body">
                <p><strong>${movie.title} (${movie.year})</strong></p>
                <p>Размер: ${movie.fileSize}</p>
                <p>Качество: ${movie.quality}</p>
                
                <div class="instructions">
                    <h4>Как скачать:</h4>
                    <ol>
                        <li>Нажмите на кнопку "Скачать файл" ниже</li>
                        <li>Сохраните файл в папку "Загрузки"</li>
                        <li>Откройте скачанный .torrent файл в вашем торрент-клиенте</li>
                        <li>Начните загрузку фильма</li>
                    </ol>
                </div>
                
                <div class="torrent-clients">
                    <h4>Рекомендуемые торрент-клиенты:</h4>
                    <ul>
                        <li>qBittorrent (бесплатный)</li>
                        <li>uTorrent</li>
                        <li>Deluge</li>
                        <li>Transmission</li>
                    </ul>
                </div>
            </div>
            <div class="torrent-instructions-footer">
                <button class="btn btn-primary" onclick="downloadTorrentDirect('${movie.downloadFile}', '${movie.title}', ${movie.year})">
                    <i class="fas fa-download"></i> Скачать файл
                </button>
                <button class="btn btn-secondary" onclick="this.closest('.torrent-instructions-modal').remove()">
                    Закрыть
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Update download count
    movie.downloadCount++;
    addToDownloads(movie);
    updateUserStats();
}

function downloadTorrentDirect(filePath, title, year) {
    try {
        const link = document.createElement('a');
        link.href = filePath;
        link.download = `${title} (${year}).torrent`;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification(`Торрент файл "${title}" скачан! Откройте его в торрент-клиенте.`, 'success');
    } catch (error) {
        console.error('Error downloading torrent:', error);
        showNotification('Ошибка при скачивании. Попробуйте правой кнопкой мыши -> "Сохранить ссылку как..."', 'error');
    }
}

function downloadRegularFile(movie) {
    // Show download progress for regular file
    showDownloadProgress(movie, 'regular');
    
    setTimeout(() => {
        try {
            // Create download link for regular file
            const link = document.createElement('a');
            
            // Use absolute path for local files
            const filePath = movie.downloadFile.startsWith('http') ? 
                movie.downloadFile : 
                window.location.origin + '/' + movie.downloadFile;
            
            link.href = filePath;
            link.download = `${movie.title} (${movie.year}).${movie.format.toLowerCase()}`;
            link.style.display = 'none';
            link.target = '_blank';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Update download count
            movie.downloadCount++;

            // Per-user counter
            const perUser = JSON.parse(localStorage.getItem('perUserDownloadCounts') || '{}');
            perUser[movie.id] = (perUser[movie.id] || 0) + 1;
            localStorage.setItem('perUserDownloadCounts', JSON.stringify(perUser));
            
            // Add to user downloads
            addToDownloads(movie);
            
            // Update user profile stats
            updateUserStats();
            
            showNotification(`Скачивание "${movie.title}" началось!`, 'success');
            
        } catch (error) {
            console.error('Error downloading file:', error);
            showNotification('Ошибка при скачивании файла', 'error');
        }
    }, 2000);
}

function updateUserStats() {
    const downloads = JSON.parse(localStorage.getItem('userDownloads')) || [];
    const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    
    const userData = JSON.parse(localStorage.getItem('userProfile')) || {};
    userData.downloads = downloads.length;
    userData.favorites = favorites.length;
    
    localStorage.setItem('userProfile', JSON.stringify(userData));
    
    // Update UI if profile modal is open
    const profileModal = document.getElementById('profileModal');
    if (profileModal && profileModal.style.display !== 'none') {
        loadUserProfile();
    }
}

function showDownloadProgress(movie, fileType = 'regular') {
    const isTorrent = fileType === 'torrent';
    const progressModal = document.createElement('div');
    progressModal.className = 'download-progress-modal';
    
    const iconClass = isTorrent ? 'fa-magnet' : 'fa-download';
    const title = isTorrent ? 'Подготовка торрент файла' : 'Подготовка к скачиванию';
    const fileTypeText = isTorrent ? 'Торрент файл' : 'Файл';
    
    progressModal.innerHTML = `
        <div class="progress-content">
            <div class="progress-icon ${isTorrent ? 'torrent-icon' : ''}">
                <i class="fas ${iconClass}"></i>
            </div>
            <h3>${title}</h3>
            <p>${movie.title}</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="progress-info">
                <span>Тип: ${fileTypeText}</span>
                <span>Размер: ${movie.fileSize}</span>
                <span>Качество: ${movie.quality}</span>
            </div>
            ${isTorrent ? '<div class="torrent-note">После скачивания откройте файл в торрент-клиенте</div>' : ''}
        </div>
    `;
    
    document.body.appendChild(progressModal);
    
    // Animate progress bar
    setTimeout(() => {
        const progressFill = progressModal.querySelector('.progress-fill');
        progressFill.style.width = '100%';
    }, 100);
    
    // Remove modal after completion
    const duration = isTorrent ? 1500 : 2000;
    setTimeout(() => {
        if (document.body.contains(progressModal)) {
            document.body.removeChild(progressModal);
        }
    }, duration);
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => notification.classList.add('show'), 100);
    
    // Remove after delay
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

// Modal Functionality
function openModal(movieId) {
    const movie = moviesData.find(m => m.id === movieId);
    if (!movie) return;
    
    const modal = document.getElementById('movieModal');
    const modalPoster = document.getElementById('modalPoster');
    const modalTitle = document.getElementById('modalTitle');
    const modalYear = document.getElementById('modalYear');
    const modalDuration = document.getElementById('modalDuration');
    const modalGenre = document.getElementById('modalGenre');
    const modalRating = document.getElementById('modalRating');
    const modalRatingValue = document.getElementById('modalRatingValue');
    const modalDescription = document.getElementById('modalDescription');
    const modalQuality = document.getElementById('modalQuality');
    const modalFileSize = document.getElementById('modalFileSize');
    const modalQualityInfo = document.getElementById('modalQualityInfo');
    const modalFormat = document.getElementById('modalFormat');
    const modalDownloadCount = document.getElementById('modalDownloadCount');
    const modalDownloadBtn = document.getElementById('modalDownloadBtn');
    const addToFavorites = document.getElementById('addToFavorites');
    
    // Update basic info
    modalPoster.src = movie.poster;
    modalPoster.alt = movie.title;
    modalTitle.textContent = movie.title;
    modalYear.textContent = movie.year;
    modalDuration.textContent = movie.duration;
    modalGenre.textContent = movie.genre;
    modalRatingValue.textContent = movie.rating;
    modalDescription.textContent = movie.description;
    
    // Update quality badge
    modalQuality.textContent = movie.quality;
    modalQuality.className = `modal-quality-badge quality-${movie.quality.toLowerCase()}`;
    
    // Update download info
    modalFileSize.textContent = movie.fileSize;
    modalQualityInfo.textContent = movie.quality;
    modalFormat.textContent = movie.format;
    modalDownloadCount.textContent = `${formatNumber(movie.downloadCount)} скачиваний`;
    
    // Update download button
    modalDownloadBtn.onclick = (e) => downloadMovie(movie.id, e);
    modalDownloadBtn.disabled = !movie.isAvailable;
    
    if (movie.isAvailable) {
        const isTorrentFile = movie.downloadFile.toLowerCase().endsWith('.torrent');
        const iconClass = isTorrentFile ? 'fa-magnet' : 'fa-download';
        const buttonText = isTorrentFile ? 'Скачать торрент' : 'Скачать';
        modalDownloadBtn.innerHTML = `<i class="fas ${iconClass}"></i> ${buttonText}`;
    } else {
        modalDownloadBtn.innerHTML = `<i class="fas fa-times"></i> Недоступно`;
    }
    
    // Update trailer button
    const modalTrailerBtn = document.getElementById('modalTrailerBtn');
    if (modalTrailerBtn) {
        modalTrailerBtn.onclick = () => openTrailerModal(movie.trailerUrl);
        modalTrailerBtn.style.display = movie.trailerUrl ? 'flex' : 'none';
    }
    
    // Update favorites button
    const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    const isFavorited = favorites.includes(movie.id);
    addToFavorites.innerHTML = isFavorited ? 
        `<i class="fas fa-heart"></i> В избранном` : 
        `<i class="fas fa-heart"></i> В избранное`;
    addToFavorites.className = `btn btn-secondary ${isFavorited ? 'favorited' : ''}`;
    addToFavorites.onclick = () => {
        toggleFavorite(movie.id);
        const newFavorites = JSON.parse(localStorage.getItem('favorites')) || [];
        const newIsFavorited = newFavorites.includes(movie.id);
        addToFavorites.innerHTML = newIsFavorited ? 
            `<i class="fas fa-heart"></i> В избранном` : 
            `<i class="fas fa-heart"></i> В избранное`;
        addToFavorites.className = `btn btn-secondary ${newIsFavorited ? 'favorited' : ''}`;
        showNotification(newIsFavorited ? 'Добавлено в избранное' : 'Удалено из избранного', 'success');
    };
    
    // Update share button
    const modalShareBtn = document.getElementById('modalShareBtn');
    if (modalShareBtn) {
        modalShareBtn.onclick = () => shareMovie(movie);
    };
    
    // Show modal
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('show'), 10);
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const modal = document.getElementById('movieModal');
    const modalContent = modal.querySelector('.modal-content');
    
    // Add closing animation
    modalContent.style.animation = 'modalContentSlideOut 0.3s ease forwards';
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset animation for next time
        modalContent.style.animation = '';
    }, 300);
}

// Theme Toggle
function toggleTheme() {
    const body = document.body;
    const themeIcon = themeToggle.querySelector('i');
    
    if (body.classList.contains('light-theme')) {
        body.classList.remove('light-theme');
        themeIcon.className = 'fas fa-moon';
        localStorage.setItem('theme', 'dark');
    } else {
        body.classList.add('light-theme');
        themeIcon.className = 'fas fa-sun';
        localStorage.setItem('theme', 'light');
    }
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    const themeIcon = themeToggle.querySelector('i');
    
    if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        themeIcon.className = 'fas fa-sun';
    } else {
        themeIcon.className = 'fas fa-moon';
    }
}

// Utility Functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Smooth scrolling for navigation
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Intersection Observer for animations
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('fade-in');
        }
    });
}, observerOptions);

// Observe movie cards for animation
document.addEventListener('DOMContentLoaded', () => {
    const movieCards = document.querySelectorAll('.movie-card');
    movieCards.forEach(card => {
        observer.observe(card);
    });
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Search suggestions (basic implementation)
function showSearchSuggestions(query) {
    if (query.length < 2) return;
    
    const suggestions = moviesData
        .filter(movie => 
            movie.title.toLowerCase().includes(query.toLowerCase())
        )
        .slice(0, 5)
        .map(movie => movie.title);
    
    // You can implement a dropdown with suggestions here
    console.log('Suggestions:', suggestions);
}

// Add to search input
searchInput.addEventListener('input', (e) => {
    showSearchSuggestions(e.target.value);
});

// Performance optimization: Lazy loading for images
function lazyLoadImages() {
    const images = document.querySelectorAll('img[loading="lazy"]');
    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src || img.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// Initialize lazy loading
document.addEventListener('DOMContentLoaded', lazyLoadImages);

// Add loading states
function showLoading() {
    moviesGrid.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
        </div>
    `;
}

// Error handling
function handleError(error) {
    console.error('Error:', error);
    moviesGrid.innerHTML = `
        <div class="error">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Произошла ошибка</h3>
            <p>Попробуйте обновить страницу</p>
        </div>
    `;
}

// Utility Functions
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// Pagination Functions
function calculateTotalPages() {
    totalPages = Math.ceil(currentMovies.length / moviesPerPage);
    return totalPages;
}

function getCurrentPageMovies() {
    const startIndex = (currentPage - 1) * moviesPerPage;
    const endIndex = startIndex + moviesPerPage;
    return currentMovies.slice(startIndex, endIndex);
}

function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * moviesPerPage + 1;
    const endIndex = Math.min(currentPage * moviesPerPage, currentMovies.length);
    const totalMovies = currentMovies.length;
    
    const paginationInfo = document.getElementById('paginationInfo');
    if (paginationInfo) {
        paginationInfo.textContent = `Показано ${startIndex}-${endIndex} из ${totalMovies} фильмов`;
    }
}

function renderPagination() {
    const pagination = document.getElementById('pagination');
    if (!pagination) return;
    
    const totalPages = calculateTotalPages();
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    renderMovies();
    updatePaginationInfo();
    renderPagination();
    
    // Scroll to top of movies section
    const moviesSection = document.querySelector('.movies-section');
    if (moviesSection) {
        moviesSection.scrollIntoView({ behavior: 'smooth' });
    }
}

function changeMoviesPerPage(newPerPage) {
    moviesPerPage = parseInt(newPerPage);
    currentPage = 1;
    renderMovies();
    updatePaginationInfo();
    renderPagination();
}

// Statistics Functions
function updateSiteStats() {
    // Track unique visitors
    const visitorId = generateVisitorId();
    if (!siteStats.uniqueVisitors.has(visitorId)) {
        siteStats.uniqueVisitors.add(visitorId);
        siteStats.totalUsers = siteStats.uniqueVisitors.size;
    }
    
    siteStats.lastVisit = new Date().toISOString();
    localStorage.setItem('siteStats', JSON.stringify({
        ...siteStats,
        uniqueVisitors: Array.from(siteStats.uniqueVisitors)
    }));
}

function generateVisitorId() {
    // Generate a unique visitor ID based on browser fingerprint
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Browser fingerprint', 2, 2);
    
    const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        canvas.toDataURL()
    ].join('|');
    
    // Simple hash function
    let hash = 0;
    for (let i = 0; i < fingerprint.length; i++) {
        const char = fingerprint.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
    }
    
    return Math.abs(hash).toString(36);
}

function countMoviesAndSeries() {
    const movies = moviesData.filter(movie => !movie.isSeries);
    const series = moviesData.filter(movie => movie.isSeries);
    
    return {
        movies: movies.length,
        series: series.length
    };
}

function updateStatistics() {
    const stats = countMoviesAndSeries();
    
    // Update movie count
    const totalMoviesEl = document.getElementById('totalMovies');
    if (totalMoviesEl) {
        animateNumber(totalMoviesEl, 0, stats.movies, 2000);
    }
    
    // Update series count
    const totalSeriesEl = document.getElementById('totalSeries');
    if (totalSeriesEl) {
        animateNumber(totalSeriesEl, 0, stats.series, 2000);
    }
    
    // Update user count
    const totalUsersEl = document.getElementById('totalUsers');
    if (totalUsersEl) {
        animateNumber(totalUsersEl, 0, siteStats.totalUsers, 2000);
    }
}

function animateNumber(element, start, end, duration) {
    const startTime = performance.now();
    const isIncreasing = end > start;
    
    function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const current = Math.floor(start + (end - start) * easeOutQuart);
        
        element.textContent = formatNumber(current);
        
        if (progress < 1) {
            requestAnimationFrame(updateNumber);
        } else {
            element.textContent = formatNumber(end);
        }
    }
    
    requestAnimationFrame(updateNumber);
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// Trailer Functions
function openTrailerModal(trailerUrl) {
    if (!trailerUrl) {
        showNotification('Трейлер недоступен', 'error');
        return;
    }
    
    const modal = document.getElementById('trailerModal');
    const iframe = document.getElementById('trailerIframe');
    
    // Convert YouTube URL to embed format
    let embedUrl = trailerUrl;
    if (trailerUrl.includes('youtube.com/watch')) {
        const videoId = trailerUrl.split('v=')[1]?.split('&')[0];
        if (videoId) {
            embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        }
    } else if (trailerUrl.includes('youtu.be/')) {
        const videoId = trailerUrl.split('youtu.be/')[1]?.split('?')[0];
        if (videoId) {
            embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        }
    }
    
    iframe.src = embedUrl;
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('show'), 10);
    document.body.style.overflow = 'hidden';
}

function closeTrailerModal() {
    const modal = document.getElementById('trailerModal');
    const iframe = document.getElementById('trailerIframe');
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        iframe.src = ''; // Stop video
        document.body.style.overflow = 'auto';
    }, 300);
}

// Share Function
function shareMovie(movie) {
    const shareData = {
        title: movie.title,
        text: `Посмотрите "${movie.title}" (${movie.year}) - ${movie.description}`,
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => showNotification('Фильм успешно поделен!', 'success'))
            .catch(() => fallbackShare(movie));
    } else {
        fallbackShare(movie);
    }
}

function fallbackShare(movie) {
    const shareText = `Посмотрите "${movie.title}" (${movie.year}) - ${movie.description}`;
    const shareUrl = window.location.href;
    
    // Copy to clipboard
    navigator.clipboard.writeText(`${shareText}\n${shareUrl}`)
        .then(() => showNotification('Ссылка скопирована в буфер обмена!', 'success'))
        .catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = `${shareText}\n${shareUrl}`;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Ссылка скопирована в буфер обмена!', 'success');
        });
}

// Add Movie Function (for admin use)
function addMovie(movieData) {
    const newMovie = {
        id: moviesData.length + 1,
        ...movieData,
        downloadCount: 0,
        isAvailable: true
    };
    // Put newly added movie first
    moviesData.unshift(newMovie);
    currentMovies = [...moviesData];
    renderMovies();
    updateStatistics(); // Update stats after adding movie
    
    showNotification(`Фильм "${newMovie.title}" добавлен!`, 'success');
}

// Remove Movie Function (for admin use)
function removeMovie(movieId) {
    const index = moviesData.findIndex(m => m.id === movieId);
    if (index > -1) {
        const movie = moviesData[index];
        moviesData.splice(index, 1);
        currentMovies = [...moviesData];
        renderMovies();
        updateStatistics(); // Update stats after removing movie
        
        showNotification(`Фильм "${movie.title}" удален!`, 'info');
    }
}

// Update Movie Function (for admin use)
function updateMovie(movieId, updates) {
    const index = moviesData.findIndex(m => m.id === movieId);
    if (index > -1) {
        moviesData[index] = { ...moviesData[index], ...updates };
        currentMovies = [...moviesData];
        renderMovies();
        
        showNotification(`Фильм "${moviesData[index].title}" обновлен!`, 'success');
    }
}

// Export functions for global access
window.toggleFavorite = toggleFavorite;
window.openModal = openModal;
window.closeModal = closeModal;
window.downloadMovie = downloadMovie;
window.addMovie = addMovie;
window.removeMovie = removeMovie;
window.updateMovie = updateMovie;

// Pagination functions
window.goToPage = goToPage;
window.changeMoviesPerPage = changeMoviesPerPage;

// Trailer and Share functions
window.openTrailerModal = openTrailerModal;
window.closeTrailerModal = closeTrailerModal;
window.shareMovie = shareMovie;

// Statistics functions
window.updateStatistics = updateStatistics;
window.updateSiteStats = updateSiteStats;

// Loading Screen Functions
function showLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.style.display = 'flex';
        loadingScreen.classList.remove('hidden');
    }
}

function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        // Add smooth exit animation
        loadingScreen.style.transition = 'all 1.2s cubic-bezier(0.4, 0, 0.2, 1)';
        loadingScreen.classList.add('hidden');
        
        // Remove from DOM after animation
        setTimeout(() => {
            loadingScreen.style.display = 'none';
        }, 1200);
    }
}

function simulateLoading(callback) {
    const progressFill = document.getElementById('progressFill');
    const loadingText = document.getElementById('loadingText');
    const loadingPercentage = document.getElementById('loadingPercentage');
    const loadingTips = document.getElementById('loadingTips');
    
    const tips = [
        "Подготавливаем лучшие фильмы для вас...",
        "Загружаем новинки кино...",
        "Обновляем каталог сериалов...",
        "Проверяем качество контента...",
        "Настраиваем персональные рекомендации...",
        "Почти готово! Осталось совсем немного..."
    ];
    
    const loadingSteps = [
        "Инициализация...",
        "Загрузка данных...",
        "Подготовка интерфейса...",
        "Настройка фильтров...",
        "Загрузка контента...",
        "Завершение..."
    ];
    
    let progress = 0;
    const totalSteps = 6;
    const stepDuration = 1000; // milliseconds per step
    
    function updateProgress(step) {
        const percentage = Math.round((step / totalSteps) * 100);
        
        // Smooth progress bar animation
        if (progressFill) {
            progressFill.style.width = percentage + '%';
        }
        
        // Update percentage with smooth transition
        if (loadingPercentage) {
            loadingPercentage.textContent = percentage + '%';
        }
        
        // Update loading text
        if (loadingText) {
            loadingText.textContent = loadingSteps[step - 1] || "Загрузка...";
        }
        
        // Update tips with fade effect
        if (loadingTips && tips[step - 1]) {
            const tipElement = loadingTips.querySelector('p');
            tipElement.style.opacity = '0';
            setTimeout(() => {
                tipElement.textContent = tips[step - 1];
                tipElement.style.opacity = '1';
            }, 200);
        }
    }
    
    function nextStep() {
        progress++;
        updateProgress(progress);
        
        if (progress < totalSteps) {
            setTimeout(nextStep, stepDuration);
        } else {
            // Add a smooth completion delay
            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }
    }
    
    // Start the loading process with initial delay
    setTimeout(nextStep, 500);
}

// Export loading functions
window.showLoadingScreen = showLoadingScreen;
window.hideLoadingScreen = hideLoadingScreen;

// Export torrent functions
window.downloadTorrentDirect = downloadTorrentDirect;

// Featured Movies Functions
function renderFeaturedMovies() {
    const featuredGrid = document.getElementById('featuredGrid');
    if (!featuredGrid) return;
    
    // Get featured movies (movies with featured: true)
    const featuredMovies = moviesData.filter(movie => movie.featured);
    
    if (featuredMovies.length === 0) {
        featuredGrid.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Нет рекомендуемых фильмов</p>';
        return;
    }
    
    featuredGrid.innerHTML = featuredMovies.map(movie => createFeaturedCard(movie)).join('');
    
    // Add event listeners to featured cards
    document.querySelectorAll('.featured-card').forEach(card => {
        card.addEventListener('click', () => {
            const movieId = parseInt(card.dataset.movieId);
            const movie = moviesData.find(m => m.id === movieId);
            if (movie) {
                openModal(movie);
            }
        });
    });
}

function createFeaturedCard(movie) {
    const isTorrentFile = movie.downloadFile.toLowerCase().endsWith('.torrent');
    const downloadIcon = isTorrentFile ? 'fa-magnet' : 'fa-download';
    const downloadText = isTorrentFile ? 'Торрент' : 'Скачать';
    
    return `
        <div class="featured-card" data-movie-id="${movie.id}">
            <div class="featured-card-poster">
                <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
                <div class="featured-card-overlay">
                    <button class="featured-play-btn" onclick="event.stopPropagation(); openModal(${movie.id})">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            </div>
            <div class="featured-card-info">
                <h3 class="featured-card-title">${movie.title}</h3>
                <div class="featured-card-meta">
                    <span>${movie.year}</span>
                    <span>•</span>
                    <span>${movie.duration}</span>
                    <div class="featured-card-rating">
                        <i class="fas fa-star"></i>
                        <span>${movie.rating}</span>
                    </div>
                </div>
                <p class="featured-card-description">${movie.description}</p>
                <div class="featured-card-actions">
                    <button class="featured-card-btn featured-card-btn-primary" onclick="event.stopPropagation(); downloadMovie(${movie.id}, event)">
                        <i class="fas ${downloadIcon}"></i>
                        ${downloadText}
                    </button>
                    <button class="featured-card-btn featured-card-btn-secondary" onclick="event.stopPropagation(); toggleFavorite(${movie.id}, event)">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// User functions
window.openProfileModal = openProfileModal;
window.closeProfileModal = closeProfileModal;
window.saveProfile = saveProfile;
window.openDownloadsModal = openDownloadsModal;
window.closeDownloadsModal = closeDownloadsModal;
window.openSettingsModal = openSettingsModal;
window.closeSettingsModal = closeSettingsModal;
window.saveSettings = saveSettings;
window.resetSettings = resetSettings;
window.selectDownloadPath = selectDownloadPath;
window.logout = logout;
window.redownloadMovie = redownloadMovie;
window.removeDownload = removeDownload;
